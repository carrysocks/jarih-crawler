## 광역 버스 데이터

버스 포털 Open API를 사용해 좌석 정보를 포함한 광역 버스 데이터를 수집합니다.
크롤러는 세 가지 다른 동작 모드를 지원합니다: 순차 (for 루프 사용), 비동기(asyncio 사용) 및 멀티 스레딩.

---
## 목차

- [설치](#설치)
- [사용법](#사용법)
- [데이터 개요](#데이터-개요)
- [데이터 수집 모드](#데이터-수집-모드)
  - [순차 (For 루프)](#순차적-for-루프)
  - [비동기 (asyncio)](#비동기-asyncio)
  - [멀티 스레딩](#멀티-스레딩)
- [성능 비교](#성능-비교)


---
### 설치


1. **레포지토리 클론**

```bash
git clone https://github.com/carrysocks/jarih-crawler.git
cd jarih-crawler
```

2. **가상 환경 설정**

```bash
virtualenv venv
source venv/bin/activate 
```

3. **의존성 설치**

```bash
pip install -r requirements.txt
```

4. **환경 변수 설정**

`.env.example`을 `.env`로 변경하고 데이터베이스 연결 세부 정보를 입력하세요.

```bash
cp .env_example .env
```

5. **데이터베이스 초기화**

TimescaleDB에서 필요한 테이블 및 하이퍼테이블을 생성하는 스크립트를 실행합니다.

```bash
python initialize_database.py
```

### 사용법

크롤러를 시작하여 데이터 수집 및 저장을 시작합니다:

```bash
python main.py --mode <mode>
```

>`<mode>` 를 다음 옵션 중 하나로 설정하세요

* sequential: 순차적 모드, for 루프를 사용하여 데이터를 수집 및 저장합니다.

* async: 비동기 모드, asyncio를 사용하여 데이터를 수집 및 저장합니다.

* threading: 멀티 스레딩 모드, threading을 사용하여 데이터를 수집하고 bulk_insert 를 통해 저장합니다.

----

### 데이터 개요

| Column          | Data Type                | Description                              |
|-----------------|--------------------------|------------------------------------------|
| time            | timestamp with time zone | 데이터 수집 시간                         |
| plate_no        | varchar(10)              | 차량 번호                                |
| plate_type      | integer                  | 차량 유형                                |
| route_id        | varchar(10)              | 노선 ID                                  |
| route_name      | varchar(10)              | 노선 이름                                |
| remain_seat_cnt | integer                  | 남은 좌석 수                             |
| station_id      | varchar(10)              | 정류장 ID                                |
| station_name    | text                     | 정류장 이름                              |
| station_seq     | integer                  | 정류장 순서                              |

데이터 예시:
```
2024-03-28 13:16:16.000000 +00:00,경기70바5595,3,200000115,5100,23,228000723,경희대정문,54
2024-03-28 13:16:16.000000 +00:00,경기70바3997,3,200000120,2007,43,200000189,장안공원,11
2024-03-28 13:16:16.000000 +00:00,경기75자7005,3,227000019,9303,43,122000156,선릉역,45

```

수집하는 광역버스 리스트:
```json
[
  ["219000026", "9700"],
  ["218000005", "3200"],
  ["227000035", "9202"],
  ["233000320", "340-2"],
  ["233000354", "M4449"],
  ["225000004", "100"],
  ["233000139", "8155"],
  ["233000077", "1000"],
  ["200000104", "3000"]
  ...
]
```

---

### 데이터 수집 모드

`순차적 (for 루프)`
순차적 모드에서 크롤러는 간단한 for 루프를 사용하여 버스 노선 목록을 반복하고 각 노선에 대해 순차적으로 API 요청을 합니다. 구현은 간단하지만 성능은 가장 좋지 않습니다. 다른 모드와의 비교를 위한 기준선으로 이 모드를 포함합니다.

`비동기 (asyncio)`
비동기 모드는 동시 API 요청을 위해 asyncio 라이브러리를 활용합니다. 
네트워크 I/O를 효율적으로 활용하기 위해서 비동기 모드를 구현했습니다. aiohttp를 사용하면 크롤러가 여러 요청을 동시에 보낼 수 있습니다. 순차적 모드보다 빠른 속도를 얻습니다.

`멀티 스레딩 (threading)`
멀티 스레딩 모드에서 크롤러는 threading 모듈을 활용하여 여러 개의 스레드를 생성하고, 각 스레드는 버스 노선의 대해 API 요청을 하는 역할을 합니다. 이 모드를 사용하면 데이터 수집 작업을 병렬로 진행합니다. GIL(Global Interpreter Lock)의 영향을 받지 않는 네트워크 I/O 작업에 효율적입니다. 
순차와 비동기 모드보다 빠른 속도를 얻습니다.

---

## 성능 비교
다음 표는 세 가지 데이터 수집 모드의 성능을 비교한 것입니다:

|모드|수집 시간(초)|저장 시간(초)| 총 시간(초)|
|------|---|---|----|
|sequential|5-10|70-80|80-90
|async|1.5-2.7|1.0|2.5-3.7
|threading|1.0-1.5|1.0-1.5|2.0-3.0




